<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codeforces Rating History</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* ... Keep your existing :root and reset (*, body) styles ... */
        :root {
            --bg-color: #1a1a2e;
            --card-color: #2c2c44;
            --text-color: #e0e0e0;
            --accent-color: #00bcd4;
            --secondary-accent: #f73859;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px; /* Added side padding for mobile */
        }

        /* --- NEW NAVIGATION STYLE --- */
        .top-nav {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-top: 10px;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
        }

        .nav-link svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            fill: var(--text-color);
            transition: fill 0.3s ease;
        }

        .nav-link:hover {
            color: var(--accent-color);
            transform: translateX(-5px); /* Subtle slide effect */
        }
        
        .nav-link:hover svg {
            fill: var(--accent-color);
        }

        /* --- UPDATED HEADER --- */
        header {
            text-align: center;
            padding-bottom: 20px;
            margin-bottom: 30px;
            /* Removed relative positioning as button is moved out */
        }

        h1 {
            color: var(--accent-color);
            font-weight: 700;
            font-size: 2.2rem; /* Increased size slightly */
        }

        .handle-display {
            font-size: 1.5em;
            color: #fce38a;
            margin-top: 5px;
        }

        /* ... Keep the rest of your CSS (Chart, Table, loading, etc.) exactly as is ... */
        
        .chart-card {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: 30px;
            height: 500px;
            position: relative;
        }

        h2 {
            color: var(--accent-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        #ratingsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        #ratingsTable th, #ratingsTable td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        #ratingsTable th {
            background-color: var(--bg-color);
            color: var(--accent-color);
            text-transform: uppercase;
            font-weight: 600;
        }

        #ratingsTable tbody tr:hover { background-color: #3d3d5f; }
        .rating-change-positive { color: #4CAF50; font-weight: 600; }
        .rating-change-negative { color: #F44336; font-weight: 600; }
        .rating-unchanged { color: #b0b0b0; }
        .hidden { display: none !important; }
        
        #loading, #error {
            text-align: center;
            padding: 40px;
            font-size: 1.5em;
            color: var(--accent-color);
        }
        #error { color: #F44336; }
        
        /* General links inside table */
        a { color: var(--accent-color); text-decoration: none; }
        a:hover { text-decoration: underline; }

    </style>
</head>
<body>

    <div class="container">
        <nav class="top-nav">
            <div class="nav-link" onclick="window.location.href='main.html'">
                <svg viewBox="0 0 24 24">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
                Back to Profile
            </div>
        </nav>

        <header>
            <h1>Codeforces Rating History</h1>
            <div class="handle-display" id="reportHandle">Loading...</div>
        </header>

        <div id="loading">Fetching rating data and generating chart...</div>
        <div id="error" class="hidden"></div>
        
        <div id="content" class="hidden">
            <section class="chart-card">
                <h2>Rating Progression</h2>
                <canvas id="ratingChart"></canvas>
            </section>
            
            <section>
                <h2>Contest Results Detail</h2>
                <table id="ratingsTable">
                    <thead>
                        <tr>
                            <th>Contest Name</th>
                            <th>Date</th>
                            <th>Old Rating</th>
                            <th>New Rating</th>
                            <th>Change</th>
                            <th>Rank</th>
                        </tr>
                    </thead>
                    <tbody id="ratingsBody">
                        </tbody>
                </table>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
           // ... (Your existing JavaScript code) ...
           // Just copy-paste your previous JS here
           const API_BASE_URL = 'https://cff-production.up.railway.app/api/v0.1/cf/user/';
           
           const reportHandle = document.getElementById('reportHandle');
           const ratingsBody = document.getElementById('ratingsBody');
           const loadingDiv = document.getElementById('loading');
           const errorDiv = document.getElementById('error');
           const contentDiv = document.getElementById('content');
           const ctx = document.getElementById('ratingChart').getContext('2d');
           let ratingChart = null;

           const getQueryParam = (name) => {
               const urlParams = new URLSearchParams(window.location.search);
               return urlParams.get(name);
           };
           
           const setVisibility = (id, visible) => {
               document.getElementById(id).classList.toggle('hidden', !visible);
           };

           const timeConverter = (UNIX_timestamp) => {
               if (!UNIX_timestamp) return 'N/A';
               const a = new Date(UNIX_timestamp * 1000);
               return a.toLocaleDateString("en-US", {
                   year: 'numeric', month: 'short', day: 'numeric'
               });
           };

           const fetchRatingHistory = async (handle) => {
               setVisibility('loading', true);
               setVisibility('error', false);
               contentDiv.classList.add('hidden');

               try {
                   const response = await fetch(`${API_BASE_URL}${handle}/rating`);
                   if (!response.ok) {
                       const errorData = await response.json();
                       throw new Error(errorData.error || `Failed to fetch rating history for ${handle}.`);
                   }
                   const ratingData = await response.json();
                   if (!ratingData || ratingData.length === 0) {
                       throw new Error("No completed contests found for this user.");
                   }
                   renderTable(ratingData);
                   renderChart(ratingData);
                   contentDiv.classList.remove('hidden');
               } catch (err) {
                   errorDiv.textContent = `Error: ${err.message}`;
                   setVisibility('error', true);
               } finally {
                   setVisibility('loading', false);
               }
           };

           const renderTable = (data) => {
               ratingsBody.innerHTML = '';
               const reversedData = [...data].reverse();
               reversedData.forEach(item => {
                   const row = ratingsBody.insertRow();
                   const change = item.newRating - item.oldRating;
                   const changeText = change > 0 ? `+${change}` : (change < 0 ? change : 0);
                   const changeClass = change > 0 ? 'rating-change-positive' : (change < 0 ? 'rating-change-negative' : 'rating-unchanged');
                   const contestUrl = `https://codeforces.com/contest/${item.contestId}`;
                   row.innerHTML = `
                       <td><a href="${contestUrl}" target="_blank">${item.contestName}</a></td>
                       <td>${timeConverter(item.ratingUpdateTimeSeconds)}</td>
                       <td>${item.oldRating}</td>
                       <td>${item.newRating}</td>
                       <td class="${changeClass}">${changeText}</td>
                       <td>${item.rank}</td>
                   `;
               });
           };
           
           const varToHex = (cssVar) => {
                const style = getComputedStyle(document.documentElement);
                const color = style.getPropertyValue(cssVar).trim();
                return color.startsWith('#') ? color : '#e0e0e0';
            }

           const renderChart = (data) => {
               const labels = data.map(item => item.contestName);
               const ratings = data.map(item => item.newRating);
               const minRating = Math.min(...ratings, 0);
               const maxRating = Math.max(...ratings);
               const suggestedMin = Math.floor(minRating / 100) * 100;
               const suggestedMax = Math.ceil(maxRating / 100) * 100;

               if (ratingChart) { ratingChart.destroy(); }

               ratingChart = new Chart(ctx, {
                   type: 'line',
                   data: {
                       labels: labels,
                       datasets: [{
                           label: 'New Rating',
                           data: ratings,
                           borderColor: varToHex('--accent-color'),
                           backgroundColor: 'rgba(0, 188, 212, 0.2)',
                           borderWidth: 3,
                           tension: 0.4,
                           pointRadius: 5,
                           pointBackgroundColor: varToHex('--secondary-accent'),
                           fill: true,
                       }]
                   },
                   options: {
                       responsive: true,
                       maintainAspectRatio: false,
                       plugins: {
                           legend: { display: false },
                           title: {
                               display: true,
                               text: `Rating Progression for ${currentHandle}`,
                               color: varToHex('--text-color'),
                               font: { size: 18 }
                           }
                       },
                       scales: {
                           x: {
                               display: true,
                               title: { display: true, text: 'Contest', color: varToHex('--text-color') },
                               ticks: { 
                                   color: varToHex('--text-color'),
                                   callback: (value, index) => labels[index].split(' (')[0]
                               },
                               grid: { color: 'rgba(255, 255, 255, 0.1)' }
                           },
                           y: {
                               display: true,
                               title: { display: true, text: 'Rating', color: varToHex('--text-color') },
                               ticks: { color: varToHex('--text-color') },
                               grid: { color: 'rgba(255, 255, 255, 0.1)' },
                               suggestedMin: suggestedMin,
                               suggestedMax: suggestedMax,
                           }
                       }
                   }
               });
           };

           let currentHandle = getQueryParam('handle');
           if (currentHandle) {
               reportHandle.textContent = currentHandle;
               fetchRatingHistory(currentHandle);
           } else {
               reportHandle.textContent = 'Error: No handle provided.';
               errorDiv.textContent = 'Please return to the main page and search for a handle.';
               setVisibility('error', true);
           }
        });
    </script>
</body>
</html>